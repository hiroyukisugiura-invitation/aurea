<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUREA | Login</title>

  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0b0d;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.12);
      --btn:rgba(255,255,255,.06);
      --btn2:rgba(255,255,255,.08);
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 600px at 90% 40%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Hiragino Sans","Noto Sans JP",system-ui,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 18px;
    }

    .wrap{
      width:min(860px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      margin-top:6px;
      margin-bottom:24px; /* ロゴと「ようこそ」の余白 */
    }
    .brand img{
      width:min(520px, 86vw);
      height:auto;
      display:block;
      opacity:.98;
    }

    .panel{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:10px;
    }

    .welcome{
      display:block;
      font-size:13px;
      color:rgba(255,255,255,.82);
      margin-top:0;
      margin-bottom:10px; /* 「ようこそ」と説明の余白 */
    }

    .desc{
      margin:0;
      font-size:12px;
      line-height:1.7;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
    }

    .btnRow{
      margin-top:6px;
      display:flex;
      gap:12px;
      width:100%;
      justify-content:center;
    }

    .btnPrimary{
      width:190px;
      max-width:calc(50% - 6px);
      height:42px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.90);
      font-size:13px;
      cursor:pointer;
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .btnPrimary:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.16);
    }
    .btnPrimary:active{transform:translateY(1px)}
    .btnPrimary:disabled{opacity:.55; cursor:not-allowed}

    .note{
      margin-top:2px;
      font-size:11px;
      line-height:1.6;
      color:rgba(255,255,255,.45);
    }

    .legalRow{
      margin-top:8px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btnGhost{
      height:26px;
      padding:0 10px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.70);
      font-size:11px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:background .15s ease, border-color .15s ease;
    }
    .btnGhost:hover{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.16);
    }

    .err{
      margin-top:6px;
      font-size:12px;
      line-height:1.6;
      color:rgba(255,200,200,.92);
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }

    @media (max-width: 420px){
      .btnPrimary{width:calc(50% - 6px)}
    }

        /* ===== Legal popup (login) ===== */
    #legalOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.45);
      z-index:99999;
      padding:18px;
    }

    .legal-modal{
      width:min(520px, calc(100% - 24px));
      max-height:calc(100vh - 64px);
      background:rgba(20,21,22,.96);
      border:1px solid rgba(255,255,255,.10);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      overflow:hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      display:flex;
      flex-direction:column;
      min-width:0;
      color:rgba(255,255,255,.92);
    }

    .legal-head{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .legal-title{
      font-size:13px;
      font-weight:700;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .legal-close{
      width:36px;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      cursor:pointer;
      font-size:18px;
      line-height:34px;
      flex:0 0 auto;
    }

    .legal-body{
      padding:14px 16px;
      overflow:auto;
      min-height:0;
      flex:1 1 auto;
    }

    .legal-body .reg-text{
      font-size:12px;
      line-height:1.7;
      color:rgba(255,255,255,.86);
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>

<body>
  <main class="wrap" aria-label="AUREA Login">
    <div class="brand" aria-hidden="true">
      <img src="/assets/img/brand/aurea_start_logo.png" alt="AUREA" />
    </div>

    <section class="panel">


      <p class="desc" id="statusMsg">初回利用にはログイン登録が必要です。&#10;Google アカウントと連携して続行してください。</p>
      <div class="err" id="errorMsg"></div>

      <div class="btnRow" role="group" aria-label="Login mode">
        <button class="btnPrimary" id="btnPersonal" type="button">Personal</button>
        <button class="btnPrimary" id="btnCompany" type="button">Company</button>
      </div>

      <div class="note">※ 未ログイン状態では AUREA 本体は利用できません</div>

      <div class="legalRow" aria-label="Legal links">
        <button class="btnGhost" type="button" data-legal="tokusho">特定商取引法に基づく表記</button>
        <button class="btnGhost" type="button" data-legal="terms">利用規約</button>
        <button class="btnGhost" type="button" data-legal="privacy">プライバシーポリシー</button>
      </div>
    </section>
  </main>

    <!-- Legal popup (same as Settings style) -->
  <div id="legalOverlay" aria-hidden="true" style="display:none;">
    <div class="legal-modal" role="dialog" aria-modal="true" aria-label="Legal">
      <div class="legal-head">
        <div class="legal-title" id="legalModalTitle">Legal</div>
        <button class="legal-close" id="btnCloseLegalModal" type="button" aria-label="Close">×</button>
      </div>
      <div class="legal-body" id="legalModalBody"></div>
    </div>
  </div>

  <!-- Firebase (compat CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <script>
    (async () => {
      "use strict";

      const AUTH_MODE_KEY = "aurea_auth_mode";
      const AUTH_STATE_KEY = "aurea_auth_state_v1";
      const INVITE_KEY = "aurea_company_invite_v1";

      const $ = (id) => document.getElementById(id);

      const statusMsg = $("statusMsg");
      const errorMsg = $("errorMsg");
      const btnPersonal = $("btnPersonal");
      const btnCompany = $("btnCompany");

            // ===== Legal popup (login) =====
      const legalOverlay = document.getElementById("legalOverlay");
      const btnCloseLegalModal = document.getElementById("btnCloseLegalModal");
      const legalModalTitle = document.getElementById("legalModalTitle");
      const legalModalBody = document.getElementById("legalModalBody");

      const TOKUSHO_POPUP_TEXT = [
        "■ 製品名：AUREA（オーリア）",
        "",
        "■ 事業代表者名：杉浦 広之",
        "",
        "■ 所在地：",
        "〒106-0044",
        "東京都港区東麻布3丁目5-15 瀬里奈グリーンハイツ903",
        "",
        "■ お問い合わせ",
        "・電話番号：090-3040-4250",
        "・メールアドレス：contact@aurea-ai.app",
        "※お問い合わせは原則「メール」での対応になります",
        "",
        "■ 販売 URL：https://aurea-2026.web.app/",
        "",
        "■ 販売価格：",
        "・Proプラン：月額 30,000円（税込）",
        "・Teamプラン：月額 69,000円（税込）",
        "・Enterpriseプラン：月額 200,000円〜（税込）",
        "",
        "■ 商品代金以外の必要料金：",
        "・インターネット接続にかかる通信料は利用者の負担となります",
        "",
        "■ 支払方法：",
        "・クレジットカード決済（Stripe）",
        "",
        "■ 支払時期：",
        "お申込み時に初回決済が行われます。",
        "但し、継続的な課金はサービス提供開始後に適用されます",
        "",
        "■ 提供時期：",
        "・決済完了後にサービスの受け渡し、提供されます",
        "",
        "■ 解約について：",
        "・本サービスは月額課金制のデジタルサービスです",
        "・ユーザーはいつでも解約することができます",
        "　(プラン解約処理は解約設定時の月末になります)",
        "・解約後も、次回更新日まではサービスをご利用いただけます",
        "・日割りによる返金は行っておりません",
        "",
        "■ 返品・返金について：",
        "デジタルサービスの性質上、購入後の返品・返金には対応しておりません",
        "但し、法令に基づく場合はこの限りではありません"
      ].join("\n");

      const TERMS_POPUP_TEXT = [
        "この利用規約（以下、「本規約」）は、",
        "AUREA（以下、「当サービス」）が提供するSaaS型サービスの利用条件を定めるものです。",
        "ユーザーは、本規約に同意した上で当サービスを利用するものとします。",
        "",
        "■ 第1条（適用）",
        "・本規約は、ユーザーと当サービスとの間の一切の関係に適用されます",
        "",
        "■ 第2条（利用登録）",
        "・当サービスの利用にあたり、ユーザーは正確な情報を登録するものとします",
        "・虚偽の情報が判明した場合、当サービスは利用停止等の措置を取ることがあります",
        "",
        "■ 第3条（利用料金および支払方法）",
        "・当サービスは月額課金制の有料サービスです",
        "・利用料金および支払方法は、当サービス上に表示される内容に従うものとします",
        "・決済は Stripe（Stripe, Inc.）を通じて行われます",
        "",
        "■ 第4条（解約）",
        "・ユーザーは、いつでも当サービスの利用を解約することができます",
        "・解約後も、次回更新日まではサービスを利用することができます",
        "・日割りによる返金は行いません",
        "",
        "■ 第5条（禁止事項）",
        "・ユーザーは、以下の行為を行ってはなりません",
        "",
        "■ 法令または公序良俗に違反する行為",
        "・不正アクセス、サービス運営を妨害する行為",
        "・第三者の権利や利益を侵害する行為",
        "・当サービスが不適切と判断する行為",
        "",
        "■ 第6条（サービスの停止・変更）",
        "・当サービスは、必要に応じて、事前の通知なくサービス内容を変更または停止することがあります",
        "",
        "■ 第7条（免責事項）",
        "・当サービスは、提供する情報の正確性や完全性について保証するものではありません",
        "・当サービスの利用により生じた損害について、一切の責任を負わないものとします",
        "",
        "■ 第8条（規約の変更）",
        "・当サービスは、本規約を必要に応じて変更することがあります",
        "・変更後の規約は、本ページに掲載された時点で効力を生じるものとします",
        "",
        "■ 第9条（準拠法・管轄）",
        "・本規約は日本法に準拠します",
        "・本サービスに関して生じた紛争については、東京地方裁判所を専属的合意管轄とします",
        "",
        "■ 第10条（お問い合わせ先）",
        "・事業代表者名：杉浦 広之",
        "・メールアドレス：contact@aurea-ai.app"
      ].join("\n");

      const PRIVACY_POPUP_TEXT = [
        "AUREA（以下、「当サービス」）は、ユーザーの個人情報の保護を重要な責務と考え、",
        "以下のとおりプライバシーポリシーを定め、適切に取り扱います。",
        "",
        "■ 1. 取得する情報",
        "当サービスでは、以下の情報を取得する場合があります。",
        "・氏名、メールアドレスなどの登録情報",
        "・ログイン情報、利用履歴、操作ログ",
        "・決済に関連する情報（※クレジットカード情報は当サービスでは保持せず、Stripeが管理します）",
        "・お問い合わせ時に提供される情報",
        "",
        "■ 2. 利用目的",
        "取得した情報は、以下の目的で利用します。",
        "・サービスの提供・運営・改善のため",
        "・本人確認、認証、セキュリティ確保のため",
        "・利用状況の分析および機能改善のため",
        "・お問い合わせへの対応のため",
        "・利用規約違反や不正行為への対応のため",
        "",
        "■ 3. 外部サービスの利用",
        "・当サービスでは、決済処理のために Stripe（Stripe, Inc.）を利用しています。",
        "・決済に関する個人情報は、Stripeのプライバシーポリシーに基づき管理されます。",
        "",
        "■ 4. 個人情報の第三者提供",
        "・法令に基づく場合を除き、本人の同意なく第三者に個人情報を提供することはありません。",
        "",
        "■ 5. 個人情報の管理",
        "・当サービスは、個人情報の漏洩、滅失、改ざん等を防止するため、",
        "・適切な安全管理措置を講じます。",
        "",
        "■ 6. 開示・訂正・削除",
        "・ユーザーは、自身の個人情報について、開示・訂正・削除を求めることができます。",
        "・ご希望の場合は、下記お問い合わせ先までご連絡ください。",
        "",
        "■ 7. プライバシーポリシーの変更",
        "・本ポリシーの内容は、必要に応じて変更されることがあります。",
        "・変更後の内容は、本ページにて公表します。",
        "",
        "■ 8. お問い合わせ先",
        "・事業担当者名：杉浦 広之",
        "・メールアドレス：contact@aurea-ai.app"
      ].join("\n");

      const openLegalModal = (key) => {
        if (!legalOverlay || !legalModalTitle || !legalModalBody) return;

        const k = (key === "terms" || key === "privacy" || key === "tokusho") ? key : "tokusho";

        const title =
          (k === "tokusho") ? "特定商取引法に基づく表記"
          : (k === "terms") ? "利用規約"
          : "プライバシーポリシー";

        const txt =
          (k === "tokusho") ? TOKUSHO_POPUP_TEXT
          : (k === "terms") ? TERMS_POPUP_TEXT
          : PRIVACY_POPUP_TEXT;

        legalModalTitle.textContent = title;
        legalModalBody.innerHTML = `<div class="reg-text">${String(txt || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}</div>`;

        legalOverlay.style.display = "flex";
        legalOverlay.setAttribute("aria-hidden", "false");
      };

      const closeLegalModal = () => {
        if (!legalOverlay) return;
        legalOverlay.style.display = "none";
        legalOverlay.setAttribute("aria-hidden", "true");
      };

      if (btnCloseLegalModal) {
        btnCloseLegalModal.addEventListener("click", (e) => {
          e.preventDefault();
          closeLegalModal();
        });
      }

      if (legalOverlay) {
        legalOverlay.addEventListener("click", (e) => {
          if (e.target === legalOverlay) closeLegalModal();
        });
      }

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        if (legalOverlay && legalOverlay.style.display !== "none") closeLegalModal();
      }, true);

      document.querySelectorAll("[data-legal]").forEach((b) => {
        b.addEventListener("click", (e) => {
          e.preventDefault();
          openLegalModal(String(b.getAttribute("data-legal") || "tokusho"));
        });
      });

      const params = new URLSearchParams(location.search);
      const modeParam = (params.get("mode") || "").trim();
      const inviteParam = (params.get("invite") || "").trim();

      const getSavedMode = () => {
        try {
          const v = localStorage.getItem(AUTH_MODE_KEY);
          return (v === "company") ? "company" : (v === "personal" ? "personal" : null);
        } catch { return null; }
      };

      const setSavedMode = (m) => {
        try { localStorage.setItem(AUTH_MODE_KEY, m); } catch {}
      };

      const getAuthState = () => {
        try {
          const raw = localStorage.getItem(AUTH_STATE_KEY);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          return (obj && typeof obj === "object") ? obj : null;
        } catch { return null; }
      };

      const setInvite = (obj) => {
        try { localStorage.setItem(INVITE_KEY, JSON.stringify(obj || {})); } catch {}
      };

      const clearInvite = () => {
        try { localStorage.removeItem(INVITE_KEY); } catch {}
      };

      const redirectToIndexOk = (user) => {
        const url = new URL("/", location.origin);
        url.searchParams.set("auth", "ok");
        url.searchParams.set("email", user.email || "");
        url.searchParams.set("uid", user.uid || "");
        location.replace(url.toString());
      };

      const redirectToIndexError = (reason) => {
        const url = new URL("/", location.origin);
        url.searchParams.set("auth", "error");
        if (reason) url.searchParams.set("reason", reason);
        location.replace(url.toString());
      };

      const showError = (text) => {
        if (errorMsg) {
          errorMsg.textContent = text || "Login error";
          errorMsg.style.display = "block";
        }
      };

      // mode 決定: URL > 保存値 > personal
      let mode = (modeParam === "company") ? "company" : (modeParam === "personal" ? "personal" : null);

      // 保存値 company は信用しない（invite URL が無い限り無効）
      if (!mode) {
        const saved = getSavedMode();
        if (saved === "company" && !inviteParam) {
          mode = "personal";
        } else {
          mode = saved || "personal";
        }
      }

      // company invite の保存（URLにあれば保存）
      if (inviteParam) {
        setInvite({ token: inviteParam, receivedAt: new Date().toISOString() });
      }
      // ===== Company login hard guard =====
      // Company は「招待URL経由のみ」許可する
      if (mode === "company") {
        // URL に invite が無い Company 遷移は即エラー
        if (!inviteParam) {
          redirectToIndexError("invite_invalid");
          return;
        }
      }

      // company アカウントを personal で使わせない（既に company loggedIn がある場合）
      const st = getAuthState();
      if (st?.loggedIn && st.mode === "company" && mode === "personal") {
        redirectToIndexError("company_personal_blocked");
        return;
      }

      // Firebase Hosting の init.json から config を自動取得
      const fetchFirebaseConfig = async () => {
        try {
          const r = await fetch("/__/firebase/init.json", { cache: "no-store" });
          if (!r || !r.ok) return null;
          const cfg = await r.json();
          return (cfg && typeof cfg === "object") ? cfg : null;
        } catch {
          return null;
        }
      };

      const cfg = await fetchFirebaseConfig();
      if (!cfg || typeof cfg !== "object") {
        showError("Firebase 設定が取得できません（/__/firebase/init.json）");
        btnPersonal.disabled = true;
        btnCompany.disabled = true;
        return;
      }

      try { firebase.initializeApp(cfg); } catch (e) { void e; }

      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();

      const consumeCompanyInvite = async (token, user) => {
        try {
          const r = await fetch("/api/company/invite/consume", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ token, email: user.email || "", uid: user.uid || "" })
          });

          if (r && r.ok) return { ok: true };
          if (r && r.status === 409) return { ok: false, reason: "invite_used" };
          if (r && r.status === 410) return { ok: false, reason: "invite_expired" };
          if (r && r.status === 403) return { ok: false, reason: "domain_not_allowed" };
          if (r && r.status === 400) return { ok: false, reason: "invite_invalid" };
          return { ok: false, reason: "invite_invalid" };
        } catch {
          return { ok: false, reason: "invite_invalid" };
        }
      };

      const handleRedirectResultOnce = async () => {
        try {
          const res = await auth.getRedirectResult();
          if (res && res.user) {
            const user = res.user;

            if (mode === "company") {
              const inv = (() => {
                try {
                  const raw = localStorage.getItem(INVITE_KEY);
                  return raw ? JSON.parse(raw) : null;
                } catch { return null; }
              })();

              const token = inv?.token ? String(inv.token) : "";
              if (!token) { redirectToIndexError("invite_invalid"); return; }

              const chk = await consumeCompanyInvite(token, user);
              if (!chk.ok) { redirectToIndexError(chk.reason); return; }
            }

            redirectToIndexOk(user);
            return;
          }
        } catch (e) {
          void e;
        }

        // 未ログイン：UIは待機（ボタン押下で開始）
        if (statusMsg) {
          statusMsg.textContent = "初回利用にはログイン登録が必要です。\nGoogle アカウントと連携して続行してください。";
        }
      };

      const startLogin = async () => {
        btnPersonal.disabled = true;
        btnCompany.disabled = true;

        try {
          const res = await auth.signInWithPopup(provider);
          const user = res && res.user;
          if (!user) throw new Error("no_user");

          if (mode === "company") {
            const inv = (() => {
              try {
                const raw = localStorage.getItem(INVITE_KEY);
                return raw ? JSON.parse(raw) : null;
              } catch { return null; }
            })();

            const token = inv?.token ? String(inv.token) : "";
            if (!token) { redirectToIndexError("invite_invalid"); return; }

            const chk = await consumeCompanyInvite(token, user);
            if (!chk.ok) { redirectToIndexError(chk.reason); return; }
          }

          redirectToIndexOk(user);
        } catch (e) {
          console.error(e);
          showError("Google ログインに失敗しました。");
          btnPersonal.disabled = false;
          btnCompany.disabled = false;
        }
      };

      btnPersonal.addEventListener("click", (e) => {
        e.preventDefault();
        mode = "personal";
        setSavedMode("personal");
        clearInvite();
        startLogin();
      });

      btnCompany.addEventListener("click", (e) => {
        e.preventDefault();
        mode = "company";
        setSavedMode("company");

        const invRaw = (() => {
          try {
            const s = localStorage.getItem(INVITE_KEY);
            return s ? JSON.parse(s) : null;
          } catch { return null; }
        })();

        const token = invRaw?.token ? String(invRaw.token) : "";
        if (!token) {
          redirectToIndexError("invite_invalid");
          return;
        }
        startLogin();
      });

      await handleRedirectResultOnce();
    })();
  </script>
</body>
</html>
