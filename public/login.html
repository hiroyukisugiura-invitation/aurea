<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AUREA | Login</title>

  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0b0d;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --line:rgba(255,255,255,.12);
      --btn:rgba(255,255,255,.06);
      --btn2:rgba(255,255,255,.08);
    }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.08), transparent 55%),
        radial-gradient(900px 600px at 90% 40%, rgba(255,255,255,.06), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Hiragino Sans","Noto Sans JP",system-ui,sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px 18px;
    }

    .wrap{
      width:min(860px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:18px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      margin-top:6px;
      margin-bottom:24px; /* ロゴと「ようこそ」の余白 */
    }
    .brand img{
      width:min(520px, 86vw);
      height:auto;
      display:block;
      opacity:.98;
    }

    .panel{
      width:min(520px, 100%);
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:10px;
    }

    .welcome{
      display:block;
      font-size:13px;
      color:rgba(255,255,255,.82);
      margin-top:0;
      margin-bottom:10px; /* 「ようこそ」と説明の余白 */
    }

    .desc{
      margin:0;
      font-size:12px;
      line-height:1.7;
      color:var(--muted);
      white-space:pre-wrap;
      word-break:break-word;
    }

    .btnRow{
      margin-top:6px;
      display:flex;
      gap:12px;
      width:100%;
      justify-content:center;
    }

    .btnPrimary{
      width:190px;
      max-width:calc(50% - 6px);
      height:42px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.90);
      font-size:13px;
      cursor:pointer;
      transition:background .15s ease, border-color .15s ease, transform .05s ease;
    }
    .btnPrimary:hover{
      background:rgba(255,255,255,.08);
      border-color:rgba(255,255,255,.16);
    }
    .btnPrimary:active{transform:translateY(1px)}
    .btnPrimary:disabled{opacity:.55; cursor:not-allowed}

    .note{
      margin-top:2px;
      font-size:11px;
      line-height:1.6;
      color:rgba(255,255,255,.45);
    }

    .legalRow{
      margin-top:8px;
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btnGhost{
      height:26px;
      padding:0 10px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(255,255,255,.70);
      font-size:11px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      transition:background .15s ease, border-color .15s ease;
    }
    .btnGhost:hover{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.16);
    }

    .err{
      margin-top:6px;
      font-size:12px;
      line-height:1.6;
      color:rgba(255,200,200,.92);
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }

    @media (max-width: 420px){
      .btnPrimary{width:calc(50% - 6px)}
    }
  </style>
</head>

<body>
  <main class="wrap" aria-label="AUREA Login">
    <div class="brand" aria-hidden="true">
      <img src="/assets/img/brand/aurea_start_logo.png" alt="AUREA" />
    </div>

    <section class="panel">


      <p class="desc" id="statusMsg">初回利用にはログイン登録が必要です。&#10;Google アカウントと連携して続行してください。</p>
      <div class="err" id="errorMsg"></div>

      <div class="btnRow" role="group" aria-label="Login mode">
        <button class="btnPrimary" id="btnPersonal" type="button">Personal</button>
        <button class="btnPrimary" id="btnCompany" type="button">Company</button>
      </div>

      <div class="note">※ 未ログイン状態では AUREA 本体は利用できません</div>

      <div class="legalRow" aria-label="Legal links">
        <a class="btnGhost" href="/legal.html">特定商取引法に基づく表記</a>
        <a class="btnGhost" href="/terms.html">利用規約</a>
        <a class="btnGhost" href="/privacy.html">プライバシーポリシー</a>
      </div>
    </section>
  </main>

  <!-- Firebase (compat CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>

  <script>
    (async () => {
      "use strict";

      const AUTH_MODE_KEY = "aurea_auth_mode";
      const AUTH_STATE_KEY = "aurea_auth_state_v1";
      const INVITE_KEY = "aurea_company_invite_v1";

      const $ = (id) => document.getElementById(id);

      const statusMsg = $("statusMsg");
      const errorMsg = $("errorMsg");
      const btnPersonal = $("btnPersonal");
      const btnCompany = $("btnCompany");

      const params = new URLSearchParams(location.search);
      const modeParam = (params.get("mode") || "").trim();
      const inviteParam = (params.get("invite") || "").trim();

      const getSavedMode = () => {
        try {
          const v = localStorage.getItem(AUTH_MODE_KEY);
          return (v === "company") ? "company" : (v === "personal" ? "personal" : null);
        } catch { return null; }
      };

      const setSavedMode = (m) => {
        try { localStorage.setItem(AUTH_MODE_KEY, m); } catch {}
      };

      const getAuthState = () => {
        try {
          const raw = localStorage.getItem(AUTH_STATE_KEY);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          return (obj && typeof obj === "object") ? obj : null;
        } catch { return null; }
      };

      const setInvite = (obj) => {
        try { localStorage.setItem(INVITE_KEY, JSON.stringify(obj || {})); } catch {}
      };

      const clearInvite = () => {
        try { localStorage.removeItem(INVITE_KEY); } catch {}
      };

      const redirectToIndexOk = (user) => {
        const url = new URL("/", location.origin);
        url.searchParams.set("auth", "ok");
        url.searchParams.set("email", user.email || "");
        url.searchParams.set("uid", user.uid || "");
        location.replace(url.toString());
      };

      const redirectToIndexError = (reason) => {
        const url = new URL("/", location.origin);
        url.searchParams.set("auth", "error");
        if (reason) url.searchParams.set("reason", reason);
        location.replace(url.toString());
      };

      const showError = (text) => {
        if (errorMsg) {
          errorMsg.textContent = text || "Login error";
          errorMsg.style.display = "block";
        }
      };

      // mode 決定: URL > 保存値 > personal
      let mode = (modeParam === "company") ? "company" : (modeParam === "personal" ? "personal" : null);

      // 保存値 company は信用しない（invite URL が無い限り無効）
      if (!mode) {
        const saved = getSavedMode();
        if (saved === "company" && !inviteParam) {
          mode = "personal";
        } else {
          mode = saved || "personal";
        }
      }

      // company invite の保存（URLにあれば保存）
      if (inviteParam) {
        setInvite({ token: inviteParam, receivedAt: new Date().toISOString() });
      }
      // ===== Company login hard guard =====
      // Company は「招待URL経由のみ」許可する
      if (mode === "company") {
        // URL に invite が無い Company 遷移は即エラー
        if (!inviteParam) {
          redirectToIndexError("invite_invalid");
          return;
        }
      }

      // company アカウントを personal で使わせない（既に company loggedIn がある場合）
      const st = getAuthState();
      if (st?.loggedIn && st.mode === "company" && mode === "personal") {
        redirectToIndexError("company_personal_blocked");
        return;
      }

      // Firebase Hosting の init.json から config を自動取得
      const fetchFirebaseConfig = async () => {
        try {
          const r = await fetch("/__/firebase/init.json", { cache: "no-store" });
          if (!r || !r.ok) return null;
          const cfg = await r.json();
          return (cfg && typeof cfg === "object") ? cfg : null;
        } catch {
          return null;
        }
      };

      const cfg = await fetchFirebaseConfig();
      if (!cfg || typeof cfg !== "object") {
        showError("Firebase 設定が取得できません（/__/firebase/init.json）");
        btnPersonal.disabled = true;
        btnCompany.disabled = true;
        return;
      }

      try { firebase.initializeApp(cfg); } catch (e) { void e; }

      const auth = firebase.auth();
      const provider = new firebase.auth.GoogleAuthProvider();

      const consumeCompanyInvite = async (token, user) => {
        try {
          const r = await fetch("/api/company/invite/consume", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ token, email: user.email || "", uid: user.uid || "" })
          });

          if (r && r.ok) return { ok: true };
          if (r && r.status === 409) return { ok: false, reason: "invite_used" };
          if (r && r.status === 410) return { ok: false, reason: "invite_expired" };
          if (r && r.status === 403) return { ok: false, reason: "domain_not_allowed" };
          if (r && r.status === 400) return { ok: false, reason: "invite_invalid" };
          return { ok: false, reason: "invite_invalid" };
        } catch {
          return { ok: false, reason: "invite_invalid" };
        }
      };

      const handleRedirectResultOnce = async () => {
        try {
          const res = await auth.getRedirectResult();
          if (res && res.user) {
            const user = res.user;

            if (mode === "company") {
              const inv = (() => {
                try {
                  const raw = localStorage.getItem(INVITE_KEY);
                  return raw ? JSON.parse(raw) : null;
                } catch { return null; }
              })();

              const token = inv?.token ? String(inv.token) : "";
              if (!token) { redirectToIndexError("invite_invalid"); return; }

              const chk = await consumeCompanyInvite(token, user);
              if (!chk.ok) { redirectToIndexError(chk.reason); return; }
            }

            redirectToIndexOk(user);
            return;
          }
        } catch (e) {
          void e;
        }

        // 未ログイン：UIは待機（ボタン押下で開始）
        if (statusMsg) {
          statusMsg.textContent = "初回利用にはログイン登録が必要です。\nGoogle アカウントと連携して続行してください。";
        }
      };

      const startLogin = async () => {
        btnPersonal.disabled = true;
        btnCompany.disabled = true;

        try {
          const res = await auth.signInWithPopup(provider);
          const user = res && res.user;
          if (!user) throw new Error("no_user");

          if (mode === "company") {
            const inv = (() => {
              try {
                const raw = localStorage.getItem(INVITE_KEY);
                return raw ? JSON.parse(raw) : null;
              } catch { return null; }
            })();

            const token = inv?.token ? String(inv.token) : "";
            if (!token) { redirectToIndexError("invite_invalid"); return; }

            const chk = await consumeCompanyInvite(token, user);
            if (!chk.ok) { redirectToIndexError(chk.reason); return; }
          }

          redirectToIndexOk(user);
        } catch (e) {
          console.error(e);
          showError("Google ログインに失敗しました。");
          btnPersonal.disabled = false;
          btnCompany.disabled = false;
        }
      };

      btnPersonal.addEventListener("click", (e) => {
        e.preventDefault();
        mode = "personal";
        setSavedMode("personal");
        clearInvite();
        startLogin();
      });

      btnCompany.addEventListener("click", (e) => {
        e.preventDefault();
        mode = "company";
        setSavedMode("company");

        const invRaw = (() => {
          try {
            const s = localStorage.getItem(INVITE_KEY);
            return s ? JSON.parse(s) : null;
          } catch { return null; }
        })();

        const token = invRaw?.token ? String(invRaw.token) : "";
        if (!token) {
          redirectToIndexError("invite_invalid");
          return;
        }
        startLogin();
      });

      await handleRedirectResultOnce();
    })();
  </script>
</body>
</html>
